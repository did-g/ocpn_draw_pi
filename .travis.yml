language: cpp

matrix:
  include:
    - dist: trusty
      compiler: gcc
    - os: osx
      compiler: clang

install:
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]];
      then
        sudo apt-get -qq update;
        sudo apt-get install libwxgtk3.0-dev libwxgtk3.0-0 libgps-dev libglu1-mesa-dev libgtk2.0-dev libbz2-dev libtinyxml-dev;
        sudo apt-get install libexpat1-dev libcairo2-dev;
        sudo apt-get install rpm;
      fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]];
      then
        brew install cairo libexif xz libarchive;
        wget http://opencpn.navnux.org/build_deps/wx312_opencpn50_macos109.tar.xz;
        tar xJf wx312_opencpn50_macos109.tar.xz -C /tmp;
        export PATH="/usr/local/opt/gettext/bin:$PATH";
        echo 'export PATH="/usr/local/opt/gettext/bin:$PATH"' >> ~/.bash_profile;
        wget http://opencpn.navnux.org/build_deps/Packages.dmg;
        hdiutil attach Packages.dmg;
        sudo installer -pkg "/Volumes/Packages 1.2.5/Install Packages.pkg" -target "/";
      fi

script:
  - if [[ "${COVERITY_SCAN_BRANCH}" == 1 ]];
    then
      echo "Don't build on coverty_scan branch.";
      exit 0;
    fi
  - mkdir build && cd build
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]];
    then
       cmake -DCMAKE_BUILD_TYPE=Release ../;
       make -sj2;
       sudo make  package;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]];
    then
        cmake -DwxWidgets_CONFIG_EXECUTABLE=/tmp/wx312_opencpn50_macos109/bin/wx-config -DwxWidgets_CONFIG_OPTIONS="--prefix=/tmp/wx312_opencpn50_macos109" -DCMAKE_INSTALL_PREFIX=/tmp/opencpn -DCMAKE_OSX_DEPLOYMENT_TARGET=10.9 ..;
        make -sj2;
        make create-pkg;
        pwd;
        ls -l;
        ( echo OAUTH_ACCESS_TOKEN=${OAUTH_ACCESS_TOKEN} > ~/.dropbox_uploader );
     fi

notifications:
    email: false
    
git:
    depth: 10

before_install:
      - if [ "$CXX" = "g++" ]; then export CXX="g++-6" CC="gcc-6"; fi


addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-6
      - g++-6

# Set encrypted variable 'GitHub_auth_token' in Travis repo settings to deploy packages
# for tagged commits to GitHub Releases.
deploy:
- provider: script
  file: $TRAVIS_BUILD_DIR/build/*.{deb,rpm,dmg,pkg,txz,pkg.tar.xz}
  script: if [ -f ~/.dropbox_uploader ];
      then
        if [[ "$TRAVIS_OS_NAME" == "osx" ]];
        then
            pwd; 
            bash ../dropbox_uploader.sh -d upload $TRAVIS_BUILD_DIR/build/*.pkg / ;
            cat /tmp/du* ;
        fi;
        if [[ "$TRAVIS_OS_NAME" == "linux" ]];
        then
            bash ./dropbox_uploader.sh upload $TRAVIS_BUILD_DIR/build/*.rpm ./;
            bash ./dropbox_uploader.sh upload $TRAVIS_BUILD_DIR/build/*.deb ./;
        fi;
      fi

  skip_cleanup: true
  on: # Set deploy conditions
      # Deploy only when tag is not specified
      tags: false
      # or this branch
      branch: t_1_5
      # and only when API token is set
      # condition: "${#GitHub_auth_token} != 0 && $BUILD_TYPE = Release"
      #condition: "${#GitHub_auth_token} != 0" 

env:
  global:
    #secure: v8tInUAkF4NbllYCjcotvQhMakRuzOWAi6y2u7btzCXnZr6mrTpBqiZlXZ4a8BEh+plFZ39aKBgaYwmPLPmqMf/BJ98ebXkzNpQT8tFEodxW9BLkorJ9dHrM3/UFnZ/xzC6O0gHap7G9L9OghtNtSlCWkd2NJ92/TVEVxmf9fNnMWaluetL+t4SyukLOX7iR4jszk1KLTO9DXlwpRsrQsbp8w2f0IBiOxaROuI3S+aZPig01/R9eQDYQTBUFFDuYVaNwpu+VIp3HJOSh27f3/WEgCwwK+Q8++geEvyjtTHDyD+kNSk0VzYlL5hsSVCkqg5J/w1YziBCCyOmxQ7+sRqTZEPpmOJkmvcPpUMQaZ/JOQYlBDKJtq57vHIzXPaZSgH/LgkPq5UzxuAJilbMlu1Nio97RB7HNQ3jwOesDKDccdQzxQyyXJletsc4v1w9eKnZOQAqu4NXvhxCTN3YvXukMyFl5SuJi6ah//Ohw3aLtDeAcpatN0SwkJHvDiSsmBkcwa0AmUKgnTloD3qdbSHMi6vh3R10FZVFKPlpDfWimBiJHMTSHp7R0ZjO/1P08kQ6QuF+KFWG5mcUkM+2fbaYM084jFHmfHhWUE9BcLYrgYEasA5aT0Z7hAYpm58y5PK+eH+Y9ltUZezQRiY96UYhndW8dHm23inQ0/TuimHI=
